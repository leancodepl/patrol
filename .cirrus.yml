test_linux_task:
  name: Test `patrol develop` on Linux
  container:
    image: ghcr.io/cirruslabs/flutter:stable
    cpu: 8
    memory: 32G
    kvm: 'true'
  env:
    PATH: $HOME/.pub-cache/bin:${PATH}
    EMULATOR_API_LEVEL: '34'
    EMULATOR_ABI: google_apis_playstore;x86_64
    EMULATOR_IMAGE: system-images;android-${EMULATOR_API_LEVEL};${EMULATOR_ABI}
  timeout_in: 30m

  setup_flutter_script: |
    flutter precache
    flutter --version
  generate_gradlew_script: |
    cd packages/patrol/example
    flutter build apk --target lib/main.dart --debug --flavor=does-not-exist &
    start=$SECONDS
    until [ -e "android/gradlew" ] || [ $(($SECONDS - start)) -ge 120 ]; do sleep 2; done
    if [ ! -e "android/gradlew" ]; then
        echo "android/gradlew was not generated within the 2 minutes timeout"
        exit 1
    fi
    kill $!
  setup_patrol_cli_script:
    - dart pub global activate --source path packages/patrol_cli && patrol
  setup_emulator_script: |
    sdkmanager --install "$EMULATOR_IMAGE"
    sdkmanager --install emulator
  create_emulator_script: |
    avdmanager -s create avd -n MyAVD -k "$EMULATOR_IMAGE"
    cat << EOF >> ~/.android/avd/MyAVD.avd/config.ini
    hw.cpu.ncore=4
    hw.gpu.enabled=yes
    hw.gpu.mode=swiftshader_indirect
    hw.ramSize=4096
    disk.dataPartition.size=6G
    vm.heapSize=576
    hw.lcd.density=440
    hw.lcd.height=2220
    hw.lcd.width=1080
    EOF
  start_emulator_background_script:
    - $ANDROID_HOME/emulator/emulator @MyAVD -verbose -no-snapshot-save -no-window -noaudio -no-boot-anim -accel on
  wait_for_emulator_script:
    - android-wait-for-emulator
  patrol_develop_script: |
    cd packages/patrol/example
    dart run patrol_develop_test.dart

test_macos_task:
  name: Test `patrol develop` on macOS
  macos_instance:
    image: ghcr.io/cirruslabs/macos-ventura-xcode:latest
  env:
    PATH: $HOME/.pub-cache/bin:${PATH}
  timeout_in: 30m
  
  setup_simulator_script: |
    xcrun simctl boot "iPhone 14 Pro Max"
  setup_flutter_script: |
    flutter channel stable
    flutter upgrade
    flutter precache
    flutter --version
  setup_patrol_cli_script:
    - dart pub global activate --source path packages/patrol_cli && patrol
  patrol_test_script: |
    cd packages/patrol/example
    flutter pub get
    dart run patrol_develop_test.dart

test_windows_task:
  name: Test `patrol develop` on Windows
  windows_container:
    image: cirrusci/windowsservercore:2019
  env:
    ANDROID_SDK_ROOT: "%CIRRUS_WORKING_DIR%\\android-sdk"
    ANDROID_HOME: "%CIRRUS_WORKING_DIR%\\android-sdk"
    PATH: "%USERPROFILE%\\AppData\\Local\\Pub\\Cache\\bin;%CIRRUS_WORKING_DIR%\\flutter\\bin;%CIRRUS_WORKING_DIR%\\android-sdk\\cmdline-tools\\latest\\bin;%CIRRUS_WORKING_DIR%\\android-sdk\\emulator;%CIRRUS_WORKING_DIR%\\android-sdk\\platform-tools;%PATH%"
    EMULATOR_CONFIG_PATH: "%CIRRUS_WORKING_DIR%\\.android\\avd\\MyAVD.avd\\config.ini"
    EMULATOR_API_LEVEL: '34'
    EMULATOR_ABI: google_apis_playstore;x86_64
    EMULATOR_IMAGE: system-images;android-${EMULATOR_API_LEVEL};${EMULATOR_ABI}
  timeout_in: 30m

  setup_flutter_script: |
    git clone https://github.com/flutter/flutter.git --depth 1 -b stable flutter
    flutter precache
  generate_gradlew_script: |
    cd packages\\patrol\\example
    flutter build apk --debug --flavor=does-not-exist || exit /b 0
  setup_patrol_cli_script:
    - dart pub global activate --source path packages\\patrol_cli && patrol
  setup_emulator_script: |
    certutil -urlcache -split -f "https://dl.google.com/android/repository/commandlinetools-win-9477386_latest.zip" cmdline-tools.zip
    tar -xf cmdline-tools.zip
    mkdir %CIRRUS_WORKING_DIR%\\android-sdk
    mkdir %CIRRUS_WORKING_DIR%\\android-sdk\\cmdline-tools
    mkdir %CIRRUS_WORKING_DIR%\\android-sdk\\platforms
    mkdir %CIRRUS_WORKING_DIR%\\android-sdk\\cmdline-tools\\latest
    move /Y %CIRRUS_WORKING_DIR%\\cmdline-tools\\* %CIRRUS_WORKING_DIR%\\android-sdk\\cmdline-tools\\latest

    sdkmanager --install "$EMULATOR_IMAGE"
    sdkmanager --install emulator
  create_emulator_script: |
    avdmanager -s create avd -n MyAVD -k "$EMULATOR_IMAGE"
    echo hw.cpu.ncore=1 >> "$EMULATOR_CONFIG_PATH"
    echo hw.gpu.enabled=yes >> "$EMULATOR_CONFIG_PATH"
    echo hw.gpu.mode=swiftshader_indirect >> "$EMULATOR_CONFIG_PATH"
    echo hw.ramSize=2048 >> "$EMULATOR_CONFIG_PATH"
    echo disk.dataPartition.size=6G >> "$EMULATOR_CONFIG_PATH"
    echo vm.heapSize=576 >> "$EMULATOR_CONFIG_PATH"
    echo hw.lcd.density=440 >> "$EMULATOR_CONFIG_PATH"
    echo hw.lcd.height=2220 >> "$EMULATOR_CONFIG_PATH"
    echo hw.lcd.width=1080 >> "$EMULATOR_CONFIG_PATH"

  start_emulator_background_script:
    - emulator @MyAVD -verbose -no-snapshot-save -no-window -noaudio -no-boot-anim -accel on
  wait_for_emulator_script:
    - android-wait-for-emulator
  patrol_develop_script: |
    cd packages\\patrol\\example
    dart run patrol_develop_test.dart
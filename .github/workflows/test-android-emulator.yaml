name: test android emulator

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */12 * * *'

jobs:
  main:
    name: Test on Android emulator
    runs-on: ubuntu-latest
    timeout-minutes: 60

    defaults:
      run:
        working-directory: packages/patrol/example

    steps:
      - name: Clone repository
        uses: actions/checkout@v3

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 11

      - name: Gradle cache
        uses: gradle/gradle-build-action@v2
        with:
          generate-job-summary: false

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Preload Flutter artifacts
        run: flutter precache

      - name: Set up Patrol CLI
        run: dart pub global activate patrol_cli

      - name: Generate Gradle wrapper
        run: flutter build apk --debug --flavor=does-not-exist || true

      - name: Install ew-cli
        run: |
          mkdir -p "$HOME/bin"
          curl "https://maven.emulator.wtf/releases/ew-cli" -o "$HOME/bin/ew-cli"
          chmod a+x "$HOME/bin/ew-cli"
          echo "$HOME/bin" >> $GITHUB_PATH
          echo "EW_API_TOKEN=${{ secrets.EW_API_TOKEN }}" >> $GITHUB_ENV

      - name: Build bundled test
        run: patrol build android --target integration_test/bundled_test.dart # TODO: change test file

      - name: Run tests
        run: >
          ew-cli
          --app build/app/outputs/apk/debug/app-debug.apk
          --test build/app/outputs/apk/androidTest/debug/app-debug-androidTest.apk
          --use-orchestrator
          --clear-package-data
          --record-video
          --timeout 20m
          --environment-variables packageName="pl.leancode.patrol.example"
          --outputs-dir emulatorwtf_output
          --outputs summary,merged_results_xml,coverage,pulled_dirs,results_xml,logcat,captured_video

      - name: Upload test outputs to artifacts
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: Results from tests
          path: ${{ github.workspace }}/packages/patrol/example/emulatorwtf_output

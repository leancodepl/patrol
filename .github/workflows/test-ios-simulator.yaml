name: test ios simulator

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */12 * * *'

jobs:
  run_tests:
    name: Flutter ${{ matrix.flutter-version }} on ${{ matrix.device }}, ${{ matrix.os }} ${{ matrix.os_version }}
    runs-on: macos-latest
    timeout-minutes: 60
    outputs:
      failure_status: ${{ steps.set_failure.outputs.failure_status }}
      error_status: ${{ steps.set_error.outputs.error_status }}

    strategy:
      fail-fast: false
      matrix:
        flutter-version: ['3.7.x']
        device: [iPhone 14, iPad (9th generation)]
        os: [iOS]
        os_version: ['16.2']

    defaults:
      run:
        working-directory: packages/patrol/example

    steps:
      - name: Clone repository
        uses: actions/checkout@v3

      - name: Switch Xcode version
        run: |
          xcode-select --print-path
          sudo xcode-select --switch /Applications/Xcode_14.0.1.app/Contents/Developer
          xcode-select --print-path

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ matrix.flutter-version }}
          cache: true

      - name: Preload Flutter artifacts
        run: flutter precache

      - name: Set up Patrol CLI
        working-directory: packages/patrol_cli
        run: dart pub global activate --source path . && patrol

      - name: Set up Bluepill
        run: brew install bluepill

      - name: Build tests
        run: |
          patrol build ios --debug --simulator \
          --exclude integration_test/android_app_test.dart \
          --exclude integration_test/service_airplane_mode_test.dart \
          --exclude integration_test/service_bluetooth_test.dart \
          --exclude integration_test/service_cellular_test.dart \
          --exclude integration_test/service_wifi_test.dart \
          --exclude integration_test/swipe_test.dart \
          --exclude integration_test/webview_leancode_test.dart \
          --exclude integration_test/webview_login_test.dart \
          --exclude integration_test/webview_stackoverflow_test.dart

      - name: Print xctestrun path in Example app
        run: |
          XCTESTRUN_PATH=$(find build/ios_integ/Build/Products -name "*.xctestrun")
          echo "$XCTESTRUN_PATH"
          echo "XCTESTRUN_PATH=$(find build/ios_integ/Build/Products -name "*.xctestrun")" >> $GITHUB_ENV

      - name: Run tests with Bluepill
        run: >
          bluepill
          --xctestrun-path "${{ env.XCTESTRUN_PATH }}""
          --output-dir "output_logs"
          --device "${{ matrix.device }}""
          --headless
          --num-sims 2
          --runtime "${{ matrix.os_version }}""
          --videos-directory "videos"

      # - name: Set simulator location
      #   run: xcrun simctl location booted set 52.17469,21.03193

      - name: Upload test outputs to artifacts
        if: success() || failure()
        uses: actions/upload-artifact@v3
        with:
          name: Logs and captured video from ${{ matrix.device }}
          path: |
            ~/Library/Logs/CoreSimulator/${{ steps.start_simulator.outputs.udid }}/system.log

      - name: Find xcresult paths
        if: success() || failure()
        run: echo "XCRESULT_PATHS=$(find ~/Library/Developer/Xcode/DerivedData -name "*.xcresult" -type d)" >> $GITHUB_ENV

      # should work for more than one path but not sure :)
      - name: Publish Test Report
        if: success() || failure()
        uses: kishikawakatsumi/xcresulttool@v1
        with:
          path: |
            ${{ env.XCRESULT_PATHS }}

      - name: Set failure
        id: set_failure
        if: always()
        run: >
          if [ "${{ steps.tests_step.conclusion }}" == "failure" ]; then
            echo "failure_status=failure" >> "$GITHUB_OUTPUT";
          fi;

      - name: Set error occurred
        id: set_error
        if: always()
        run: >
          if [ "${{ steps.tests_step.conclusion }}" == "skipped" ] || [ "${{ steps.tests_step.conclusion }}" == "cancelled" ]; then
            echo "error_status=error" >> "$GITHUB_OUTPUT";
          fi;

  slack_notify:
    name: Notify on Slack
    runs-on: ubuntu-latest
    needs: run_tests
    if: ${{ false }}
    # Change to always()

    steps:
      - name: Set Slack message
        id: slack_message
        env:
          FAILURE_STATUS: ${{ needs.run_tests.outputs.failure_status }}
          ERROR_STATUS: ${{ needs.run_tests.outputs.error_status }}
        run: >
          if [ ! -z "$FAILURE_STATUS" ]; then
            message="There were failing tests 💥 ";
            status="failure";
          elif [ ! -z "$ERROR_STATUS" ]; then
            message="Something went wrong ⚠️";
            status="failure";
          else
            message="All tests have passed ✅ ";
            status="success";
          fi;

          url="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}";
          echo "message=$message" >> $GITHUB_OUTPUT;
          echo "url=$url" >> $GITHUB_OUTPUT;
          echo "status=$status" >> $GITHUB_OUTPUT;

      - name: Share test results on Slack
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_CHANNEL: ${{ vars.SLACK_STATUS_CHANNEL }}
          SLACK_USERNAME: Patrol CI on GitHub Actions
          SLACK_COLOR: ${{ steps.slack_message.outputs.status }}
          SLACK_ICON: ${{ vars.SLACK_ICON }}
          SLACK_TITLE: Test status (iOS Simulator)
          SLACK_MESSAGE: |
            ${{ steps.slack_message.outputs.message }}

            See workflow run <${{ steps.slack_message.outputs.url }}|here>

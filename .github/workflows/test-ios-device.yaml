name: test ios device

on:
  workflow_dispatch:
  schedule:
    - cron: '30 21 * * *'

jobs:
  main:
    name: Test on iOS device on Firebase Test Lab
    runs-on: macos-latest
    timeout-minutes: 60

    defaults:
      run:
        working-directory: packages/patrol/example

    steps:
      - name: Clone repository
        uses: actions/checkout@v3

      - name: Add current platform
        working-directory: packages/patrol/example/ios
        run: bundle lock --add-platform x86_64-darwin-20
        
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.0'
          bundler-cache: true
          working-directory: 'packages/patrol/example/ios'

      - name: Set up fastlane
        run: brew install fastlane

      - name: Run fastlane match
        working-directory: packages/patrol/example/ios
        run: fastlane certificates "APP_STORE_KEY_ID":"${{ secrets.APP_STORE_KEY_ID }}" "APP_STORE_ISSUER_ID":"${{ secrets.APP_STORE_ISSUER_ID }}" "APP_STORE_KEY":"${{ secrets.APP_STORE_KEY }}"
         
      - name: Run fastlane match2
        if: false
        uses: maierj/fastlane-action@v3.0.0
        env:
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          GIT_USERNAME: ${{ secrets.PATROL_FASTLANE_CERTS_REPO_TOKEN_USERNAME }}
          GIT_TOKEN: ${{ secrets.PATROL_FASTLANE_CERTS_REPO_TOKEN }}
        with:
          lane: 'certificates'
          options: '{ "APP_STORE_KEY_ID": "${{ secrets.APP_STORE_KEY_ID }}", "APP_STORE_ISSUER_ID": "${{ secrets.APP_STORE_ISSUER_ID }}", "APP_STORE_KEY": "${{ secrets.APP_STORE_KEY }}" }'
          subdirectory: 'packages/patrol/example/ios'

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: '${{ secrets.GOOGLE_SERVICE_ACCOUNT_KEY_JSON }}'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ matrix.flutter-channel }}

      - name: Preload Flutter artifacts
        run: flutter precache

      - name: Run example_test.dart
        run: ./run_ios_testlab integration_test/example_test.dart
        if: success() || failure()

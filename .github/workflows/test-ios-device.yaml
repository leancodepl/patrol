name: test ios device

on:
  workflow_dispatch:
  schedule:
    - cron: '30 21 * * *'

jobs:
  run_tests:
    name: Flutter ${{ matrix.flutter-version }} on ${{ matrix.device-model }} iOS ${{ matrix.device-version }} on FTL
    runs-on: macos-latest
    timeout-minutes: 60
    outputs:
      failure_status: ${{ steps.set_status.outputs.failure_status }}
      error_status: ${{ steps.set_status.outputs.error_status }}

    strategy:
      fail-fast: false
      matrix:
        flutter-version: ['3.7.x']
        device-model: ['iphone11pro']
        device-version: ['16.3']

    defaults:
      run:
        working-directory: packages/patrol/example

    steps:
      - name: Clone repository
        uses: actions/checkout@v3

      - name: Add current platform to Gemfile
        working-directory: packages/patrol/example/ios
        run: bundle lock --add-platform ruby
        
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.0"
          bundler-cache: true
          working-directory: packages/patrol/example/ios

      - name: Set up fastlane
        working-directory: packages/patrol/example/ios
        run: bundle install

      - name: Run fastlane match
        working-directory: packages/patrol/example/ios
        env:
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          GIT_USERNAME: ${{ secrets.PATROL_FASTLANE_CERTS_REPO_TOKEN_USERNAME }}
          GIT_TOKEN: ${{ secrets.PATROL_FASTLANE_CERTS_REPO_TOKEN }}
          APP_STORE_KEY_ID: ${{ secrets.APP_STORE_KEY_ID }}
          APP_STORE_ISSUER_ID: ${{ secrets.APP_STORE_ISSUER_ID }}
          APP_STORE_KEY: ${{ secrets.APP_STORE_KEY }}
        run: bundle exec fastlane ios certificates

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: '${{ secrets.GOOGLE_SERVICE_ACCOUNT_KEY_JSON }}'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ matrix.flutter-version }}
          cache: true

      - name: Preload Flutter artifacts
        run: flutter precache

      - name: Set up Patrol CLI
        working-directory: packages/patrol_cli
        run: dart pub global activate --source path . && patrol

      - name: Build tests
        run: |
          patrol build ios --release \
            --target integration_test/example_test.dart \
            --target integration_test/open_app_test.dart \
            --target integration_test/permissions_many_test.dart \
            --target integration_test/service_dark_mode_test.dart

      - name: Compress test files to zip
        run: |
          cd "build/ios_integ/Build/Products"
          zip -r ios_tests.zip \
            Release-iphoneos/Runner.app \
            Release-iphoneos/RunnerUITests-Runner.app \
            Runner_iphoneos16.2-arm64.xctestrun

      - name: List devices capacities
        run: gcloud firebase test ios list-device-capacities

      - name: Upload APKs to Firebase Test Lab and wait for tests to finish
        id: tests_step
        run: ./run_ios_testlab

        # RESULTS_DIR_NAME is created by run_android_testlab script
      - name: Get test outputs from Google Cloud Storage
        if: success() || failure()
        run: |
          mkdir "test_outputs"
          gsutil -m cp -r "gs://patrol_runs/${{ env.RESULTS_DIR_NAME }}/${{ matrix.device-model }}-${{ matrix.device-version }}-en_US-portrait/*" "test_outputs"

      - name: Find xcresult path
        if: success() || failure()
        run: echo "XCRESULT_PATH=$(find ${{ github.workspace }}/packages/patrol/example/test_outputs/TestLogs -name "*.xcresult" -type d)" >> $GITHUB_ENV

      - name: Publish test report to summary
        if: success() || failure()
        uses: kishikawakatsumi/xcresulttool@v1
        with:
          title: Patrol tests on ${{ matrix.device-model }} iOS ${{ matrix.device-version }}
          upload-bundles: never
          path: |
            ${{ env.XCRESULT_PATH }}

      - name: Upload XML test report to artifacts
        uses: actions/upload-artifact@v3
        if: success() || failure()
        with:
          name: XML test report
          path: ${{ github.workspace }}/packages/patrol/example/test_outputs/*.xml

      - name: Upload XCRESULT test result to artifacts
        uses: actions/upload-artifact@v3
        if: success() || failure()
        with:
          name: Test-Runner.xcresult
          path: ${{ github.workspace }}/packages/patrol/example/test_outputs/TestLogs/*.xcresult

      - name: Upload captured video to artifacts
        uses: actions/upload-artifact@v3
        if: success() || failure()
        with:
          name: Captured video
          path: ${{ github.workspace }}/packages/patrol/example/test_outputs/*.mp4

      - name: Check if error or failed test occured during run
        id: set_status
        if: always()
        run: >
          if [ -z ${{ env.TESTS_EXIT_CODE }} ]; then
            echo "error_status=error" >> "$GITHUB_OUTPUT";
          elif [ ! ${{ env.TESTS_EXIT_CODE }} == 0 ]; then
            echo "failure_status=failure" >> "$GITHUB_OUTPUT";
          fi;

  slack_notify:
    name: Notify on Slack
    runs-on: ubuntu-latest
    needs: run_tests
    if: ${{ always() }}

    steps:
      - name: Set Slack message
        id: slack_message
        env:
          failure_status: ${{ needs.run_tests.outputs.failure_status }}
          error_status: ${{ needs.run_tests.outputs.error_status }}
        run: >
          if [ ! -z "$error_status" ]; then
            message="Something went wrong ⚠️ ";
            status="failure";
          fi;
          if [ ! -z "$failure_status" ]; then
            if [ ! -z "$message" ]; then
              message+=" and there were failing tests 💥 ";
            else
              message+="There were failing tests 💥 ";
              status="failure";
            fi;
          fi;
          if [ -z "$message" ]; then
              message="All tests have passed ✅ ";
              status="success";
          fi;

          url="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}";
          echo "message=$message" >> $GITHUB_OUTPUT;
          echo "url=$url" >> $GITHUB_OUTPUT;
          echo "status=$status" >> $GITHUB_OUTPUT;

      - name: Share test results on Slack
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_CHANNEL: ${{ vars.SLACK_STATUS_CHANNEL }}
          SLACK_USERNAME: Patrol CI on GitHub Actions
          SLACK_COLOR: ${{ steps.slack_message.outputs.status }}
          SLACK_ICON: ${{ vars.SLACK_ICON }}
          SLACK_TITLE: Test status (iOS device on Firebase Test Lab)
          SLACK_MESSAGE: |
            ${{ steps.slack_message.outputs.message }}

            See workflow run <${{ steps.slack_message.outputs.url }}|here>

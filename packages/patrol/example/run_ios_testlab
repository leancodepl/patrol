#!/usr/bin/env bash
set -euo pipefail

RESULTS_DIR_NAME="$(date +"%Y-%m-%d_%H:%M:%S")"
echo "RESULTS_DIR_NAME=$RESULTS_DIR_NAME" >> "$GITHUB_ENV"

dev_target="16.3"
product="build/ios_integ/Build/Products/Release-iphoneos"

xcodebuild -showBuildSettings | grep IPHONEOS_DEPLOYMENT_TARGET

pushd "$product"
ls -all
zip -r ios_tests.zip "Runner_iphoneos$dev_target-arm64.xctestrun"
popd

exec gcloud firebase test ios run \
	--type xctest \
	--test "$product/ios_tests.zip" \
	--device model=iphone11pro,version="$dev_target",locale=en_US,orientation=portrait \
	--timeout 20m \
	--results-bucket="patrol_runs" \
	--results-dir="$RESULTS_DIR_NAME"

#!/usr/bin/env bash
set -euo pipefail

# Run your command and store the output in a variable
set +e
output="$(gcloud firebase test android run \
	--type instrumentation \
	--app build/app/outputs/apk/debug/app-debug.apk \
	--test build/app/outputs/apk/androidTest/debug/app-debug-androidTest.apk \
	--device model=oriole,version=33,locale=en,orientation=portrait \
	--timeout 10m \
	--results-bucket="patrol_runs" \
	--use-orchestrator \
	--environment-variables clearPackageData=true 2>&1)"
set -e

TESTS_EXIT_CODE=$?

# Extract the last link using grep, tail, and sed, and write it to Github Summmary
link="$(echo "$output" | grep -o 'https://[^ ]*' | tail -1 | sed 's/\[//;s/\]//')"
echo "## [Check out run artifacts here (Leancode members only)]($link)" >> "$GITHUB_STEP_SUMMARY"

exit $TESTS_EXIT_CODE

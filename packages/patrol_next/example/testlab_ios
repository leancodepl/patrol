#!/usr/bin/env bash
set -euo pipefail

output="../build/ios_integ"
product="build/ios_integ/Build/Products"
dev_target="16.1"

# Pass --simulator if building for the simulator.
flutter build ios integration_test/example_test.dart --release

pushd ios
xcodebuild build-for-testing \
	-workspace Runner.xcworkspace \
	-scheme Runner \
	-config Flutter/Release.xcconfig \
	-derivedDataPath "$output" \
	-sdk iphoneos
popd

pushd "$product"
zip -r "ios_tests.zip" "Release-iphoneos" "Runner_iphoneos$dev_target-arm64.xctestrun"
popd

xcodebuild test-without-building \
	-xctestrun "build/ios_integ/Build/Products/Runner_iphoneos$dev_target-arm64.xctestrun" \
	-destination id="$(idevice_id -l)"


# gcloud firebase test ios run \
#	--test "build/ios_integ/Build/Products/ios_tests.zip" \
#	--device model=iphone13pro,version="$dev_target",locale=en_US,orientation=portrait
